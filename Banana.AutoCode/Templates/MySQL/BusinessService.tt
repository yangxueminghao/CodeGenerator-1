<#
//------------------------------------------------------------------------------
// <copyright file="BusinessService.tt">
//    Copyright (c) 2018, https://github.com/yuanrui All rights reserved.
// </copyright>
// <author>Yuan Rui</author>
// <date>2021-12-15 18:00:00</date>
//------------------------------------------------------------------------------
#>
<#@ template debug="false" hostspecific="true" language="C#" #>
<#@ output encoding="utf-8" extension=".cs" #>
<#@ include file="../TemplateFileManager.ttinclude" #>
<# 
	CustomHost host = (CustomHost)(Host);
	Table table = host.Table;
    var entClassName = table.DisplayName + "Entity";
    var pkCol = table.PrimaryKeyColumns.First();
    var pkTypeName = pkCol.TypeName;
    var manager = Manager.Create(host, GenerationEnvironment);
	manager.StartNewFile(table.DisplayName + "ServiceBase.generated.cs", host.GetValue("OutputPath").ToString() + "\\MySQL\\Banana.Services\\Generated");
#>
//------------------------------------------------------------------------------
// <copyright file="<#= table.DisplayName #>ServiceBase.generated.cs">
//    Copyright (c) <#= DateTime.Now.ToString("yyyy") #>, All rights reserved.
// </copyright>
// <author><#= Environment.UserName #></author>
// <date><#= DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") #></date>
// <auto-generated>
//    This code was generated by AutoCode.exe
//    Template Version:20230227
//
//    Changes to this file may cause incorrect behavior and will be lost if
//    the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

namespace Banana.Services.Base
{
    using System;
    using System.Collections.Generic;
    using System.Data;
    using System.Linq;
    using System.Text;
    using Banana.DataAccess;
    using Banana.Entity;
    using Simple.Data;

    public abstract partial class <#= table.DisplayName #>ServiceBase : ServiceBase<<#= entClassName #>>
    {
        private readonly String _connectionName;
        
        protected virtual String ConnectionName
        {
            get { return _connectionName; }
        }

        protected readonly <#= table.DisplayName #>SqlProvider Provider;

        public <#= table.DisplayName #>ServiceBase(String connectionName)
        {
            _connectionName = connectionName;
            Provider = new <#= table.DisplayName #>SqlProvider(connectionName);
        }
        
        public virtual Int64 GetNewId()
        {
            const String sql = "select nextid(@seqName)";
            var result = DbUtils.ExecuteScalar<Int64>(sql, new { seqName = Provider.TableName });
            
            return result;
        }

        public virtual Boolean Exists(<#= table.PrimaryKeyColumns.Select(m => String.Format("{0} {1}", m.TypeName, m.Name)).Aggregate((a, b) => a + ", " + b) #>)
        {
            using(var scope = DataContextScope.GetCurrent(ConnectionName).Begin())
            {
                var result = Provider.Exists(<#= table.PrimaryKeyColumns.Select(m => m.Name).Aggregate((a, b) => a + ", " + b) #>);
            
                return result;
            }
        }

        public virtual Boolean Exists(<#= entClassName #> entity)
        {
            if(entity == null)
            {
                throw new ArgumentNullException("entity");
            }

            return Exists(<#= table.PrimaryKeyColumns.Select(m => "entity." + m.PascalCase).Aggregate((a, b) => a + ", " + b) #>);
        }
        
        public virtual <#= entClassName #> Get(<#= table.PrimaryKeyColumns.Select(m => String.Format("{0} {1}", m.TypeName, m.Name)).Aggregate((a, b) => a + ", " + b) #>)
        {
            using(var scope = DataContextScope.GetCurrent(ConnectionName).Begin())
            {
                var result = Provider.Get(<#= table.PrimaryKeyColumns.Select(m => m.Name).Aggregate((a, b) => a + ", " + b) #>);
            
                return result;
            }
        }
        
        public virtual Pager<<#= entClassName #>> GetPager(Int32 pageIndex, Int32 pageSize)
        {
            using (var scope = DataContextScope.GetCurrent(ConnectionName).Begin())
            {
                var result = Provider.GetPager(<#= table.DisplayName #>SqlProvider.Fill, pageIndex, pageSize, Provider.TableName, "<#= table.PrimaryKeyColumns.Select(m => m.Name).Aggregate((a, b) => a + ", " + b) #>", "<#= table.PrimaryKeyColumns.Select(m => m.Name).Aggregate((a, b) => a + ", " + b) #>", "*", String.Empty);
                return result;
            }
        }
        
        public virtual Boolean Add(<#= entClassName #> entity)
        {
            if(entity == null)
            {
                throw new ArgumentNullException("entity");
            }
            
            using(var scope = DataContextScope.GetCurrent(ConnectionName).Begin(true))
            {
                var result = Provider.Add(entity) > 0;
                scope.Commit();

                return result;
            }
        }
        
        public virtual Boolean Add(IEnumerable<<#= entClassName #>> list)
        {
            if(list == null)
            {
                throw new ArgumentNullException("list");
            }

            var count = list.Count();
            if(count == 0)
            {
                return false;
            }

            using(var scope = DataContextScope.GetCurrent(ConnectionName).Begin(true))
            {
                var result = Provider.Add(list) == count;
                scope.Commit();
                
                return result;
            }
        }

        public virtual Boolean Update(<#= entClassName #> entity)
        {
            if(entity == null)
            {
                throw new ArgumentNullException("entity");
            }

            using(var scope = DataContextScope.GetCurrent(ConnectionName).Begin(true))
            {
                var result = Provider.Update(entity) > 0;
                scope.Commit();
                
                return result;
            }
        }

        public virtual Boolean Update(IEnumerable<<#= entClassName #>> list)
        {
            if(list == null)
            {
                throw new ArgumentNullException("list");
            }
            
            var count = list.Count();
            if(count == 0)
            {
                return false;
            }

            var result = 0;
            using(var scope = DataContextScope.GetCurrent(ConnectionName).Begin(true))
            {
                foreach(var entity in list)
                {
                    result += Provider.Update(entity);
                }

                scope.Commit();
                
                return result == count;
            }
        }
        
        public virtual Boolean Save(<#= entClassName #> entity)
        {
            if(entity == null)
            {
                throw new ArgumentNullException("entity");
            }
            
            using(var scope = DataContextScope.GetCurrent(ConnectionName).Begin(true))
            {
                var result = Provider.Save(entity) > 0;
                scope.Commit();
                
                return result;
            }
        }

        public virtual Boolean Save(IEnumerable<<#= entClassName #>> list)
        {
            if(list == null)
            {
                throw new ArgumentNullException("list");
            }
            
            var count = list.Count();
            if(count == 0)
            {
                return false;
            }

            var result = 0;
            using(var scope = DataContextScope.GetCurrent(ConnectionName).Begin(true))
            {
                foreach(var entity in list)
                {
                    result += Provider.Save(entity);
                }

                scope.Commit();
                
                return result >= count;
            }
        }
        
        public virtual Boolean Delete(<#= table.PrimaryKeyColumns.Select(m => String.Format("{0} {1}", m.TypeName, m.Name)).Aggregate((a, b) => a + ", " + b) #>)
        {
            using(var scope = DataContextScope.GetCurrent(ConnectionName).Begin(true))
            {
                var result = Provider.Delete(<#= table.PrimaryKeyColumns.Select(m => m.Name).Aggregate((a, b) => a + ", " + b) #>) > 0;
                scope.Commit();
            
                return result;
            }
        }

        public virtual Boolean Delete(<#= entClassName #> entity)
        {
            if(entity == null)
            {
                throw new ArgumentNullException("entity");
            }

            return Delete(<#= table.PrimaryKeyColumns.Select(m => "entity." + m.PascalCase).Aggregate((a, b) => a + ", " + b) #>);
        }

        public virtual Boolean Delete(IEnumerable<<#= entClassName #>> list)
        {
            if(list == null)
            {
                throw new ArgumentNullException("list");
            }

            var count = list.Count();
            if(count == 0)
            {
                return false;
            }

            var result = 0;

            var @paramList = Provider.BuildParametersForKey(list);

            using(var scope = DataContextScope.GetCurrent(ConnectionName).Begin(true))
            {
                foreach(var entity in list)
                {
                    result += Provider.Delete(entity);
                }

                scope.Commit();
                
                return result == count;
            }
        }
    }
}
<# 
	manager.EndBlock(); 
    manager.StartNewFile(table.DisplayName + "Service.cs", host.GetValue("OutputPath").ToString() + "\\MySQL");
#>
//------------------------------------------------------------------------------
// <copyright file="<#= table.DisplayName #>Service.cs">
//    Copyright (c) <#= DateTime.Now.ToString("yyyy") #>, All rights reserved.
// </copyright>
// <author><#= Environment.UserName #></author>
// <date><#= DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") #></date>
//------------------------------------------------------------------------------

using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using Banana.DataAccess;
using Banana.Entity;
using Banana.Services.Base;
using Simple.Data;

namespace Banana.Services
{
    /// <summary>
    /// Service for <#= entClassName #>
    /// <see cref="<#= entClassName #>"/>
    /// </summary>
    public partial class <#= table.DisplayName #>Service : <#= table.DisplayName #>ServiceBase
    {
        const String DefaultConnectionString = "DefaultConnectionString";

        #region Constructor

        public <#= table.DisplayName #>Service() : this(DefaultConnectionString)
        {
        }

        public <#= table.DisplayName #>Service(String connectionName) : base(connectionName)
        {
        }

        #endregion

        public virtual List<<#= entClassName #>> FindAll()
        {
            using (var scope = DataContextScope.GetCurrent(ConnectionName).Begin())
            {
                return Provider.FindAll(String.Empty);
            }
        }
    }
}
<# 
	manager.EndBlock(); 
    manager.Process(true);
#>